1，直流有刷电机(DC)
	H桥(三极管)、电压、电流电路-运放
	编码器及定时器溢出，PID(控制周期)-香农采样(采样f=2信号f)、实际值突变能力，冒泡排序，一阶低通滤波(滤波系数0~1)。
	1ms进行脉冲读取->5ms进行脉冲变化(速度)->2(10ms)进行速度滤波：冒泡+一阶低通滤波->50ms进行PID控制。
	速度环、电流环、角度环控制。  PID结果后进行一阶低通滤波pwm。
	舵机20ms的PWM，脉宽0.5~2.5ms，0~180。  注：控制电平要和实际硬件电路联系起来，选择合适的PWM模式！
	PWM2(信号反向)
	
2，步进电机
	位置-脉冲个数，转速-脉冲频率。
	细分驱动(电流)，DIR+EN+SPEED。
	PWM-ARR改变频率，翻转模式-CCR改变频率。
	角度->脉冲数->CC中断改变脉冲数(2次进入中断一个脉冲)。
	梯形加减速：频率加-均匀-减。周期T的计算->加速与减速的步数  速度和步数->运动阶段  步数=脉冲数。
	S型加减速：加加速阶段步数-减加速阶段步数-确认下一个脉冲周期。
	直线插补：至少2步进-多运动轴，分配驱动脉冲。  X+Y合成。 偏差。
	曲线插补：X-Y分布走。
	闭环系统：编码器

3，直流无刷电机
	方波驱动-BLDC，正弦波-PMSM。
	六步换相：UVW->PWM调制->位置检测。
	电角度=机械角度*极对数。
	有感BLDC-逆变电路、PWM上桥臂、HALL及真值表。
	函数指针的使用。  RPM-圈/min。
	双环控制：电流环+转速环。  有感UVW-HUVW
	无感驱动：UVW，反电动势过零点检测与换相(延迟30°导通换相)，运放比较器与中性点电路设计。  比较器信号->HALL信号。
开环加速->闭环换相。磁极对数->电角度->比较器的脉冲(电流)频率。
无刷直流电机无感控制：速度闭环、速度+电流双闭环。   电流环->主要针对有负载。
	SPWM:面积等效(方波->正弦波  等幅不等宽)-傅里叶级数   正弦波->由方波w等,调宽(占空比)级数叠加  占空比=1/T  T=1/f
	SVPWM:平均值等效原理
4，FOC实战
	UVW三相同时导通，常用永磁直流无刷电机(PMSM)-反电动势-正弦波。 SVPWM合成电压空间矢量。(SPWM仅是针对单相)
磁场矢量控制方法。  

5，
	(1)死区-上下管，COM事件-6步-接口定时器(HALL)-TRGI，BEMF=U-压降，接口定时器(计数CNT-捕获、主从、延时动作CCR2-PWM2)-控制定时器-主从及复位-TRGO(换向)，HALL也可以EXTI。
	(2)步进:脉冲数+脉冲频率(脉冲时间间隔=c/f)，步数+加减速度， 定时器计数-第n个脉冲-加减速与平稳， 加减速-步数-脉冲-每一步时间间隔，  手段->定时器CCR
		加速度=c0步进延时--下一个脉冲比较值， 状态机-步数，  输出翻转->中断变更CCR,步进数  设置->执行
	(3)SPWM:调制波(输入信号)、载波(频谱信号)-周期与幅值  (U/I)跟踪控制->滞环环节  中心对齐-CNT作为载波-CCR阈值界(类调制波-脉宽)  
		载波比恒定:1正弦周期内的脉冲数恒定-->查表法调制SPWM  底部采样  同步调制--f同步
	(4)FOC:PMSM-正弦反电动势，n3!组合开关->空间电压矢量->旋转电压->电源角频率,  开关次数-7段/5段,  ap空间坐标系  扇区->矢量T->三相CCR
		调制波(隐含)-相电压/线电压函数-马鞍/正弦
		坐标变换-解耦, 本质:FOC就是把定子电流分解为与转子磁链同相的直轴分量及正交的交轴分量.  Clark:标幺量(U1/Un常用百分数表示),  𝒊𝐝值控制磁通，而𝒊𝐪值控制电机转矩==>转速
		位置与转速:HALL、光电、ABZ位置传感器,  电流滑动控制器SMC--观测器--位置和速度,  反电动势->角度    滤波--需补偿  
		电流矢量控制--最大转矩电流比控制、id*=0控制、弱磁控制(弱反电动势、提速)、cosφ=1控制
		本质:空间位置对力矩的控制   调节磁场->磁力->转矩->转速  T=转子磁场*定子磁场  弱磁控制-恒转矩-恒功率-正弦电流频率
	
		无感PMSM:位置检测算法-Observer+PLL(BEMF)、高频注入算法(IPMSM)。
		TIM1->ADC采样点(P471)---SVPWM调制指数(导通时间反比)、死区时间、噪声时间、采样转换时间
		转子位置信息->PARK/CLEAK     iα和 iβ和转子的位置信息(𝜃𝑟𝑒𝑙)结合计算得到iq和id   电流参考值𝑖𝑞𝑠∗和𝑖𝑑𝑠∗以给FOC_Model函数调用
		IPMSM-内嵌式永磁同步电机-MTPA(IPMSM的最大转矩电流比)=iq/id
		矢量幅值饱和等于|𝑉⃗ ∗| = sqrt(𝑉𝑑∗2 + 𝑉𝑞∗2)---圆限制(合矢量的内切圆)
		PID参数自整定，  !!!SVPWM信号<->BEMF与HALL信号，!!!  周期测量频率1:1000   霍尔信号频率-采样(分辨率)-定时器计数(预分频)
		电频率=磁极对数 x 机械频率   电频率=磁极对数 x 机械频率
		霍尔传感器信号捕获中断服务函数：转子旋转方向确定、 计算电角度、计算新的预分频器值、 更新速度周期 FIFO 缓冲区、 转子电频率计算

		BLDC:集中绕组,BEMF-梯形波,CTR-方波(直流-逆变-交流),直流电机,6步
		PMSM:分布短距绕组,BEMF-正弦波,CTR-三相正弦波(交流),同步电机,FOC

		FOC（Filed Oriented Control）是采用数学方法实现三相马达的力矩与励磁的解耦控制。
主要是对电机的控制电流进行矢量分解，变成励磁电流Id 和交轴电流Iq ，励磁电流主要是产生励磁，控制的是磁场的强度，而交轴电流是用来控制力矩，所以在实际使用过程中，我们常令I d = 0 Id=0Id=0 
		FOC（电机矢量控制）要求严格的转子磁场定向，对于BLDC电机而言转子磁场方向始终与转子位置一致，因此其控制输入需要准确的转子绝对位置信号
DTC（直接转矩控制）实际上与基于定子磁场定向，而定子磁场则是依据电压积分估算获得，在这个过程中跟转子位置没有关系，其控制过程中用到的量也都是静止坐标系下的量，
因此DTC控制相比于FOC控制要简单很多，完全不需要求解三角函数、坐标变换，如果需要用DTC进行速度闭环则需要测量电机的速度，但是依然不需要准确的绝对位置。
		本质；矢量控制，它的基本思想就是一致的：将多变量、强耦合、非线性、时变的交流电机复杂矢量系统通过解耦（坐标变换）的方式等效成直流电机的简单标量系统。
		BLDC转矩波动-BENF顶部大于120°,不转矩波动(理论)- 梯形~=正弦 - FOC - 位置信息传感器
	(5)编码器校准:0度相位-定子角度-编码器	预启动(转矩iq和磁通id校准/SVPWM)-加速-运行
	ST-FOC源码分析 2024.2.27


6,本质
	(1)有效非零矢量-作用时间-调制比   abc->ap坐标，引入方向(欧拉变换)  定方向，动大小(作用时间)  电压矢量增加角度  调制比=调制波基波峰值/载波基波峰值
	(2)零矢量平均分配-PWM对称-降低PWM谐波分量   Ts代表载波周期，即开关周期  
	(3)在三相正弦波中注入了零序分量的调制波进行规则采样的一种变形SPWM(调制波-正弦波)  SVPWM(正弦波+零序分量)
	(4)坐标变换、 PID 算法、 SVPWM 技术和新变换角（变相角度）--电机转子位置（𝛉）和速度（𝛚）=>有传感器/无传感器
	(5)电机单相模型->Is->电流观测器->反电动势->位置    theta+w->滤波->延迟->相位补偿
	(6)abc->ap坐标变换,引入方向(欧拉变换)    ap定方向,动大小(作用时间)-->合成矢量反之  (ap-欧拉系)
	(7)有效非零适量-作用时间-调制比(利用率=调制波幅值/载波幅值)  7段式SVPWM/5段式SVPWM  
	(8)定子磁场-扭力 与转子力臂垂直    FOC建模-将转子磁通作为定子和气隙磁通的参考坐标系-力追踪转子位置  SVPWM-电压同步转子位置   励磁/转矩分量
	(9)FOC关键:对电流矢量的幅值和空间位置(频率和相位)的控制    转子磁极位置-逆变器输出频率-转子角频率(异步-同步)  id-转速,iq-转矩(直流)  (定子坐标)电流空间矢量->dq(转子坐标)->反变换->FOC
	(10)电机转矩正比于 转子磁场 叉积 定子磁场.   电流-磁场-力-转矩-速度  U=磁场的微分(dB/dS=U)  磁动势=有效匝数*电流   
	
	外面旋转磁场旋转 → 切割了鼠笼的金属导体 → 金属导体产生了电动势 → 由于鼠笼短接所以金属导体就产生了感应电流 → 感应电流产生了一个磁场（转子磁场）

//-----------------------------------------------------------------------------------------------------------

电角度： 一个点的磁极发生变化从N到S级 变化的时候，代表电角度是180度（这个很多人都不讲）。所以电角度=极对数（或者级数/2）*机械角度
bldc FOC控制里面， park变换，用的就是电角度。千万别搞错哦。


同步调制-正弦周期脉冲数固定-采样点-载波与调制波交点-CCR与调制波的关系(幅值-调制比、频率-ARR)-正弦幅值映射0~100%占空比-查表法-面积等效原理
角度小增量： =2𝜋/𝑅 =2𝜋𝑓/𝑓𝑠 =2𝜋𝑇𝑠/𝑇     1扇区会有多个𝛾，多个开关周期(载波周期)，多个7段SVPWM-功率开关管，实时更新T4、T6->a b c三相的CCR
SPWM 方法从电源的角度出发，以生成一个可调频调压的正弦波电源，
而 SVPWM 方法将逆变系统和异步电机看作一个整体来考虑，模型比较简单，也便于微处理器的实时控制。

Ua、Up->合成矢量扇区判断、基本矢量作用时间->a、b、c三相的CCR值
过调制=逆变器输出电压波形将发生失真=>输出磁链非圆形=>+0矢量作用时间=>磁链圆为正六边形的内切圆
Ua、Up->T4 T6 T7=T0->过调制处理->T4'、T6'、T7'=T4'=0

转子位置：有感-增量式光电编码器、光电式位置传感器、霍尔位置传感器
无感-BEMF、状态观测器
无感FOC: (1)电流观测器(BEMF模型)->滑膜(SMC)->校准因子z->I-估算 I-实测
(2)校准因子z->LPF->Is->反电动势Es->Ea Ep->估算角度     (Is->Ia、Ib的Clarke变换->Ia Ip->Ea Ep)
(3)角速度计算

!!! fpwm=f载波=f开关=20khz=>三角波的计数需要定为=168MHz/20000 = 8200=>中心对齐则为8200/2 !!!!   (168MHZ下，PWM载波频率，对应的载波计数)--即区分载波频率与载波计数
载波(三角波)频率=计数器更新频率  => 载波比 => 调制波频率
调制比=>调制波放大倍数a
fpwm(Tpwm)与载波计数

ST FOC库：
(1)MC_type.h：电流(电压)Iq Id、状态观测器(位置与速度、PLL)、MTPA(IPMSM的最大转矩电流比)=iq/id、三环PID、系统和电源状态

(2)MC_Key.c、MC_Display.c：按键调速与方向、显示控制界面

(3)stm32f10x_Timebase.c：500us中断

(4)MC_Globals.c：Ua、Up、三环PID

(5)STM32F10x_MCconf.h：采样电阻、有感/无感、MTPA/弱磁/前馈PID、DAC

(6)MC_Control_Param.h：Fpwm、Deadtime、调制比、电流环(转矩环)采样频率与Fpwm、温度与电压的阈值范围、速度环调节周期及其采样-PID(Kp/Ki/Kd参数及限幅)、
PID=>转矩环-Iq->磁通环-Id、电机频率与PID系数的线性

(7)MC_encoder_param.h：编码器及接口、一圈脉冲数、转子rpm、磁场定向控制->绝对位置校准

(8)MC_hall_prm.h：HALL及接口、转子rpm与dpp

(9)MC_State_Observer_param.h：PLL环、Iabc、SMC滑膜、启动时间与加速度、三相电流启动增长、速度观测方差及处理方式、观测器参数、
电机绕组和电感相互作用->电流、电压与反电动势、速度dpp转化、启动过程频率/电流增加的斜率

(10)MC_PMSM_motor_param.h：电机绕阻R/L与极对数、额定电流、最大转速

(11)MC_pwm_3shunt_prm.h：时钟、Fpwm、Deadtime、采样/噪声/上升/死区时间、采样的时间间隔设计

(12)STM32x_svpwm_3shunt.c：ADC+DMA和SVPWM配置初始化、PWM2配置TRGO->ADC->SVPWM、ADC校准处理零漂、
磁链和转矩 PID 调节器采样频率=(2*PWM_FREQ)/(REP_RATE + 1)、下桥臂打开时，分别Ia Ib Ic采样及q1.15格式、
采样时刻Duty、死区DT、噪声Tn、转化Ts   4扇区不对C相采样：PWM_PERIOD-hTimePhC(等效于上桥臂导通) > TW_AFTER // T下桥臂>Tn+DT
载波计数ARR/2-CCR=T下桥臂>Tn+DT

采集Ia Ib:
情况1：ΔDutyA>DT+TN=>A下桥臂载波计数溢出;

情况2：(DT+TN+TS)/2<ΔDutyA<DT+TN 和 ΔDutyAB<DT+TR+TS =>A下桥臂载波计数溢出之后，DT+TN
情况3：ΔDutyA<(DT+TN+TS)/2       和 ΔDutyAB>DT+TR+TS =>A上桥臂载波计数下降到CCR下(即A上桥臂关断前)
由2、3 ==> ΔDutyAB>2*ΔDutyA，因为一般TR>TN

情况4：ΔDutyA<(DT+TN+TS)/2 	  和 ΔDutyAB<DT+TR+TS =>无法采样

Ts可取  TW_BEFORE(A相上桥臂关断前即可)  TW_AFTER=DT+TN

ps:四扇区下，采流时刻可上桥臂101(对应下桥臂010)，因采集的是相电流，Ia+Ib可采集。

扇区公式：调制比->T与PWM的计数倍数关系，形成作用时间->有效矢量作用时间->Ua Up=>ccr_a ccr_b ccr_c
7段式SVPWM=>基本矢量作用时间=>叠加A B C正脉冲保持时间(CCR计数)

(13)MC_FOC_Drive.c：PMSM力矩和磁通(FOC算法含PID)、弱磁、 PID反馈控制调节速度、电流前馈(速度环/外部输入ref进行预测补偿)
PID_Torque_InitStructure：转矩分量控制  PID_Flux_InitStructure：磁通分量控制
控制直轴电流id可以削弱磁通，进而进行弱磁扩速。(弱磁扩速框图知，是Id++，最大可用正交电流Iq会减小(因为恒功率=UI)，最大可传递电磁转矩也会减小)   

(14)MC_Clarke_Park.c：q1.15格式存储数据、s16角度正弦x-y、98%调制指数下，过调制的幅值限制
调制指数越大,circle_limit_table 需要的元素量越少

(15)MC_PID_regulators.c： 三环PID、简易PID参数自整定

(16)stm32f10x_hall.c：HALL安装方式、HALL角度与电角度同步(同步电角度)-BEMF与电角度零点(BEMF过零点与HALL波形=>同步电角度)
Fhall:Ftim=1:1000,随转速调tim的分频系数、速度格式(dpp-Tfoc与电角度变化、hz)  、HALL外设的配置-捕获/更新分频系数中断、转子电频率dpp、
定时器捕获值、定时器预分频值、旋转方向
转子转速(dpp)--对应的定时器周期、电角度获取

(17)stm32f10x_encoder.c：rotor位置/速度、预定位--编码器零点校准、机械角度、电角度、溢出次数和编码器计数、机械频率(speed)

(18)MC_State_Observer_Interface.c：	BEMF、PLL及增益PI、启动及速度dpp、系统是否收敛及可靠性、启动：转子预定位、外同步加速、运行
无感-加速/切换、启动电流(参考转矩)，启动励磁频率(角度计算)==>FOC加速
STO_Calc_Rotor_Angle观测器参数：测量的定子电流、施加的电压命令、测量的直流母线电压=>反电动势𝑒𝛼和𝑒𝛽=>PLL=>估计速度和角度

Luenberger观测器：输出 y 与输入 u 来实现对系统状态（包括可测状态与不可测状态）的观测---状态(BEMF、相电流)，
系统收敛稳定(u&y)=>具体实现方式是通过配置 G 矩阵使得观测器的极点都具有负实部，这样观测器观测到的状态与系统实际状态之差则可以在有限时间收敛到 0，
从而保证观测器的稳定性与准确性。

(19)MC_MotorControl_Layer.c：FOC初始化、过温过压

(20)stm32f10x_MCdac.c：参数PWM写入ADC_VALUE

(21)stm32f10x_it.c：刹车、TRGO触发ADC采流->FOC

(22)main.c：3电阻采样、有感/无感初始化、电机状态更新



高级定时器->PWM2 TRGO->ADC电流采样->FOC->SVPWM
HALL->CCR1输入捕获、CCR2捕获中断

TIM1:ch1 ch2 ch3 pwm1，ch4 pwm2->TRGO->输出比较事件中断-ADC-SVPWM

TRGO中断频率可以设置为HALL捕获频率的整数倍，例如2倍、4倍等

//-----------------------------------------------------------------------------------------------------------



位置环->速度环->电流环(内环)：电流反馈控制电机电流(扭矩)->控制扭矩来控制电机转速->控制转速来控制电机位置

(1)调制比(幅值)-载波比(采样及调制频率关系-数量关系)
f位置环<f速度环<f电流环==>几十赫兹<几百赫兹<几千赫兹  励磁电流Id--励磁磁场强度、交轴电流Iq--转矩(力矩)
两相电流(KCL)、位置信息(有感-HALL、编码器；无感-观测器)-角度+速度
定子系(abc)-定子系(ap)-转子系(dq)   角度信息-电角度信息

(2)最大转矩控制：当励磁电流分量为0时，磁通完全由永磁体提供。电机所有的电流全部用来产生电磁转矩，只用控制Iq就可以控制电机转矩，就实现了电机的静态解耦。
F=BIL，B=>永磁体、电流变化产生，实现指定力矩=>需要控制单一变量I，则要B的电流产生的分量为0(Id=0)，最终的参考分量Id=0、Iq=ref(稳速)
Vq、Vd本身的参考值已定，Iq、Id只是根据反馈差值调节电机稳定性。

(3)SVPWM：平均值等效原理(等效磁链圆)：𝑈𝑟𝑒𝑓 ∙ 𝑇𝑧 = 𝑈4 ∙ 𝑇4 + 𝑈6 ∙ 𝑇6，有效作用时间T4+T6=Tz-T0  控制电压矢量作用时间，使电压空间矢量接近按圆轨迹旋转  
SPWM：面积等效原理(冲量/面积)：窄脉冲面积相等而形状不同->输出响应波形同
基本电压矢量->合成电压矢量->投影分解三相电压  基本电压矢量-sa sb sc开关(功率开关管)
KV高，最高输出电流大，扭力小，转速快。

(4)DTC与FOC-Ia Ib Ic和Udc，输出的就是六路两两互补的pwm波，外部电路一样，只是算法实现a到b路径不同。
--DTC与MPCC一类，就是直接选择八个空间状态矢量，或者其组合(双矢量MPCC或三矢量)，计算矢量作用时间及选择哪几个矢量最优    定子磁场定向
--FOC就是Id Iq控制，一般Id=0，弱磁、最大转矩电流比，位置获取DTC/FOC都有感无感，无感观测器(低速高频注入；中高速滑膜、龙伯格、磁链、卡尔曼、模型参考自适应)   转子磁场定向

(5)Ua Up->作用时间  
SVPWM：合成空间电压矢量幅值最大不会超过图中所示的正六边形边界。而当合成矢量落在该边界之外时，将发生过调制，逆变器输出电压波形将发生失真。正六边形内切圆幅值√3/3*𝑈𝑑𝑐。
SPWM:逆变器能输出的不失真 最大正弦相电压幅值为Udc/2
过调制处理:Tx+Ty>Ts，比例关系把两个非零矢量作用时间矫正

(6)机械角度->极对数->电角度->SVPWM
调制波、载波->调制比(A)-输出波形电压幅值/载波电压幅值(计数)， 载波比(f)-每个正弦周期内的载波所含正弦调制波输出的 脉冲总数之比=1正弦周期的脉冲总数
调制波与载波->SPWM->自然采样、规则采样(对称-载波底点采样1次；非对称-载波峰值采样2次)->开关导通脉宽及导通时刻  ps:定时器ccr与脉宽频率(载波)+调制波w=>调制SPWM
跟踪控制->滞环比较

(7)基础：调制波和载波=>交点时刻对开关器件进行通断控制，采样时刻1/2次=每个脉冲周期有1/2次采样
SPWM的查表法：SPWM的等面积原理+查表法的映射与占空比
锁相环PLL重构转子电角度和速度

SVPWM:中断1-Update事件->CNT&CCR->CC4输出比较中断   中断2--计数溢出更新->CNT->TRG0->ADC采流->FOC->SVPWM
HALL:CCR1输入捕获，CCR2随着转子转速提高捕获频率--改变PSC
接口定时器+PWM互补输出高级定时器

编码器相对位置，转子磁场定向绝对位置->角度校准->零参考Iq Id->预定位(角度/相位校准)->ENC_Start_Up()

磁通=Id变化产生+永磁体
Id=0->磁通完全由永磁体提供，实现解耦。
转矩分量=交轴分量=Iq   励磁分量(磁通)=直轴分量=Id=弱磁扩速   B--Id、T--Iq
!!磁通分量Bq、Bd=>叉积为转矩!!   
T->B->I合->Id、Iq->直轴磁场Bd、转矩(交轴磁场Bq、空间位置)    圆周运动,最大转矩为切向量    Bd=B励磁+B永磁，B励磁为定子电流于转子内产生的磁场
相位校准--定子磁场和转子磁场的对齐，可令Iq=0，Id按指定方向赋值->定下磁场对齐最终方向(也算是解耦控制)

I定子绕组=I合->转子互感励磁+定子自感励磁  耦合:磁场相对位置+磁场强度

//--------------------------------------------------
SimpleFOC
相位校准：机械角度与电角度偏差、

电气转速(rpm)=机械转速x极对数/60，Fhall=电气转速x极对数x2




